---
date: "2021-03-23T15:18:01+06:00"
title: Custom Management Procedures
weight: 5
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<p><code>openMSE</code> was designed to be extensible in order to promote the development of new Management Procedures. In this section we design a series of new Management Procedures that include spatial controls and input controls in the form of size limit restrictions.</p>
<p>If you wish, you can also add your newly developed MPs to the package so they are accessible to other uses. Of course you will be credited as the author. Please <a href="/contact/">contact us</a> for details how to do this.</p>
<p>As described in the <a href="/tutorial-populating-data/">Populating the Data object</a> section, real data are stored in a class of objects <code>Data</code>.</p>
<p>The <a href="/features-running-mse/"><code>runMSE</code> function</a> generates simulated data and puts it in exactly the same format as real data. This is highly desirable because
it means that the same MP code that is tested in the MSE can then be used to make management recommendations.</p>
<p>If an MP is coded incorrectly it may catastrophically fail MSE testing and will therefore be excluded from use in management.</p>
<div id="a-constant-catch-mp" class="section level3">
<h3>A Constant Catch MP</h3>
<p>We’ve now got a better idea of the <a href="/features-management-procedures/anatomy/">anatomy of an MP</a>. It is a function that must accept three arguments (we will ignore <code>plot</code> for now):</p>
<ul>
<li>x: a simulation number</li>
<li>Data: an object of class <code>Data</code></li>
<li>reps: the MP can provide a sample of TACs <code>reps</code> long.</li>
</ul>
<p>Let’s have a go at designing our own custom MP that can work with <code>openMSE</code> We’re going to develop an MP that sets the TAC as the ‘3rd highest catch’.</p>
<p>We decide to call our function <code>THC</code></p>
<pre class="r"><code>THC&lt;-function(x, Data, reps){
  
  # Find the position of third highest catch
  
  THCpos&lt;-order(Data@Cat[x,],decreasing=T)[3]
  
  # Make this the mean TAC recommendation
  
  THCmu&lt;-Data@Cat[x,THCpos]
  
  # A sample of the THC is taken according to a fixed CV of 10%
  TACs &lt;- THCmu * exp(rnorm(reps, -0.1^2/2, 0.1)) # this is a lognormal distribution

  Rec &lt;- new(&quot;Rec&quot;) # create a &#39;Rec&#39;object
  Rec@TAC &lt;- TACs # assign the TACs to the TAC slot
  Rec # return the Rec object
}</code></pre>
<p>To recap that’s just seven lines of code:</p>
<pre class="r"><code>THC&lt;-function(x, Data, reps){
  THCpos&lt;-order(Data@Cat[x,],decreasing=T)[3]
  THCmu&lt;-Data@Cat[x,THCpos]
  Rec &lt;- new(&quot;Rec&quot;)
  Rec@TAC &lt;- THCmu * exp(rnorm(reps, -0.1^2/2, 0.1))
  Rec
}</code></pre>
<p>We can quickly test our new MP for the example Data object</p>
<pre class="r"><code>THC(x=1,Data,reps=10)@TAC</code></pre>
<pre><code>##  [1] 4084.666 4233.960 4320.225 4247.745 3975.688 4635.546 4017.359 4417.738
##  [9] 4813.774 5363.664</code></pre>
<p>Now that we know it works, to make the function compatible with the DLMtool package we have to assign it the class ‘MP’ so that DLMtool recognizes the function as a management procedure</p>
<pre class="r"><code>class(THC)&lt;-&quot;MP&quot;</code></pre>
</div>
<div id="a-more-complex-mp" class="section level3">
<h3>A More Complex MP</h3>
<p>The THC MP is simple and frankly not a great performer (depending on depletion, life-history, adherence to TAC recommendations).</p>
<p>Let’s innovate and create a brand new MP that could suit a catch-data-only stock like Indian Ocean Longtail tuna!</p>
<p>It may be possible to choose a single fleet and establish a catch rate that is ‘reasonable’ or ‘fairly productive’ relative to current catch rates. This could be for example, 40% of the
highest catch rate observed for this fleet or, for example, 150% of current cpue levels.</p>
<p>It is straightforward to design an MP that will aim for this target index level by making adjustments to the TAC.</p>
<p>We will call this MP <code>TCPUE</code>, short for target catch per unit effort:</p>
<pre class="r"><code>TCPUE&lt;-function(x,Data,reps=100){
  
  mc&lt;-0.05                             # max change in TAC 
  frac&lt;-0.3                            # target index is 30% of max
  nyears&lt;-length(Data@Ind[x,])         # number of years of data
  
  smoothI&lt;-smooth.spline(Data@Ind[x,]) # smoothed index  
  targetI&lt;-max(smoothI$y)*frac         # target 
  
  currentI&lt;-mean(Data@Ind[x,(nyears-2):nyears]) # current index
  
  ratio&lt;-currentI/targetI              # ratio currentI/targetI
  
  if(ratio &lt; (1 - mc)) ratio &lt;- 1 - mc # if currentI &lt; targetI
  if(ratio &gt; (1 + mc)) ratio &lt;- 1 + mc # if currentI &gt; targetI
 
  Rec &lt;- new(&quot;Rec&quot;)
  Rec@TAC &lt;- Data@MPrec[x] * ratio * exp(rnorm(reps, -Data@CV_Ind[x]^2/2, Data@CV_Ind[x]))
  Rec
}</code></pre>
<p>The <code>TCPUE</code> function simply decreases the past TAC (stored in <code>Data@MPrec</code>) if the index is lower than the target and increases the TAC if the index is higher than the target.</p>
<p>All that is left is to assign the function as class <code>MP</code> so that <code>openMSE</code> recognizes it as a management procedure:</p>
<pre class="r"><code>class(TCPUE)&lt;-&quot;MP&quot;</code></pre>
</div>
<div id="beyond-the-catch-limit" class="section level3">
<h3>Beyond the Catch Limit</h3>
<p>All management procedures return an <a href="/object-rec/">object of class <code>Rec</code></a> that contains 13 slots:</p>
<pre class="r"><code>slotNames(&quot;Rec&quot;)</code></pre>
<pre><code>##  [1] &quot;TAC&quot;      &quot;Effort&quot;   &quot;Spatial&quot;  &quot;Allocate&quot; &quot;LR5&quot;      &quot;LFR&quot;     
##  [7] &quot;HS&quot;       &quot;Rmaxlen&quot;  &quot;L5&quot;       &quot;LFS&quot;      &quot;Vmaxlen&quot;  &quot;Fdisc&quot;   
## [13] &quot;DR&quot;       &quot;Misc&quot;</code></pre>
<p>We’ve already seen the TAC slot in the previous example. The remaining slots relate to various forms of input control:</p>
<ul>
<li>Effort (total allowable effort (TAE) relative to last historical year)</li>
<li>Spatial - Fraction of each area that is open</li>
<li>Allocate - Allocation of effort from closed areas to open areas</li>
<li>LR5 - Length at 5% retention</li>
<li>LFR - Length at 100% retention</li>
<li>HS - Upper slot limit</li>
<li>Rmaxlen - Retention of the maximum length class</li>
<li>L5 - Length at 5% selection (e.g a change in gear type)</li>
<li>LFS - Length at 100% selection (e.g a change in gear type)</li>
<li>Vmaxlen - Selectivity of the maximum length class</li>
<li>Fdisc - Update the discard mortality if required</li>
<li>Misc - An optional slot for storing additional information</li>
</ul>
<p>See the <a href="https://msetool.openmse.com/reference/Rec-class.html">help documentation</a> or type <code>class?Rec</code> in the R console for more information on the contents of the <code>Rec</code> object.</p>
<p>The <code>curE</code> MP just keeps effort constant at current levels:</p>
<pre class="r"><code>curE</code></pre>
<pre><code>## function (x, Data, reps, plot = FALSE) 
## {
##     rec &lt;- new(&quot;Rec&quot;)
##     rec@Effort &lt;- 1
##     if (plot) 
##         curE_plot(x, rec, Data)
##     rec
## }
## &lt;bytecode: 0x000000001d76bf68&gt;
## &lt;environment: namespace:DLMtool&gt;
## attr(,&quot;class&quot;)
## [1] &quot;MP&quot;</code></pre>
<p>Note that only the <code>Effort</code> slot in the <code>Rec</code> object is populated in this case.</p>
<p>To highlight the differences among Input control MPs, examine the spatial control MP <code>MRreal</code> that closes area 1 to fishing and reallocates fishing to the open area 2:</p>
<pre class="r"><code>MRreal</code></pre>
<pre><code>## function (x, Data, reps, plot = FALSE) 
## {
##     rec &lt;- new(&quot;Rec&quot;)
##     rec@Allocate &lt;- 1
##     rec@Spatial &lt;- c(0, rep(1, Data@nareas - 1))
##     if (plot) 
##         barplot(rec@Spatial, xlab = &quot;Area&quot;, ylab = &quot;Fraction Open&quot;, 
##             ylim = c(0, 1), names = 1:Data@nareas)
##     return(rec)
## }
## &lt;bytecode: 0x000000001d8e1fc8&gt;
## &lt;environment: namespace:DLMtool&gt;
## attr(,&quot;class&quot;)
## [1] &quot;MP&quot;</code></pre>
<p>In contrast <code>MRnoreal</code> does not reallocate fishing effort:</p>
<pre class="r"><code>MRnoreal</code></pre>
<pre><code>## function (x, Data, reps, plot = FALSE) 
## {
##     rec &lt;- new(&quot;Rec&quot;)
##     rec@Allocate &lt;- 0
##     rec@Spatial &lt;- c(0, rep(1, Data@nareas - 1))
##     if (plot) 
##         barplot(rec@Spatial, xlab = &quot;Area&quot;, ylab = &quot;Fraction Open&quot;, 
##             ylim = c(0, 1), names = 1:Data@nareas)
##     return(rec)
## }
## &lt;bytecode: 0x000000001da75a08&gt;
## &lt;environment: namespace:DLMtool&gt;
## attr(,&quot;class&quot;)
## [1] &quot;MP&quot;</code></pre>
<p>The MP <code>matlenlim</code> only specifies the parameters of length retention using an estimate of length at 50% maturity (<code>Stock@L50</code>):</p>
<pre class="r"><code>matlenlim</code></pre>
<pre><code>## function (x, Data, reps, plot = FALSE) 
## {
##     rec &lt;- new(&quot;Rec&quot;)
##     rec@LFR &lt;- Data@L50[x]
##     rec@LR5 &lt;- rec@LFR * 0.95
##     if (plot) 
##         size_lim_plot(x, Data, rec)
##     rec
## }
## &lt;bytecode: 0x000000001dd82db0&gt;
## &lt;environment: namespace:DLMtool&gt;
## attr(,&quot;class&quot;)
## [1] &quot;MP&quot;</code></pre>
<div id="an-example-effort-control" class="section level4">
<h4>An Example Effort Control</h4>
<p>Here we will copy and modify the MP we developed earlier to specify a new version of the target catch per unit effort MP (<code>TCPUE</code>) that provides effort recommendations:</p>
<pre class="r"><code>TCPUE_e&lt;-function(x,Data,reps=100){
  
  mc&lt;-0.05                             # max change in TAC 
  frac&lt;-0.3                            # target index is 30% of max
  nyears&lt;-length(Data@Ind[x,])         # number of years of data
  
  smoothI&lt;-smooth.spline(Data@Ind[x,]) # smoothed index  
  targetI&lt;-max(smoothI$y)*frac         # target 
  
  currentI&lt;-mean(Data@Ind[x,(nyears-2):nyears]) # current index
  
  ratio&lt;-currentI/targetI              # ratio currentI/targetI
  
  if(ratio &lt; (1 - mc)) ratio &lt;- 1 - mc # if currentI &lt; targetI
  if(ratio &gt; (1 + mc)) ratio &lt;- 1 + mc # if currentI &gt; targetI
  
  rec &lt;- new(&quot;Rec&quot;)
  rec@Effort &lt;- Data@MPeff[x] * ratio
  rec
  
}</code></pre>
<p>There have been surprisingly few changes to make TCPUE an input control MP that sets total allowable effort.</p>
<ol style="list-style-type: decimal">
<li>We have had to use stored recommendations of effort in the <code>Data@MPeff</code> slot, and</li>
<li>The final line of the MP is our input control recommendation that only modified the Effort.</li>
</ol>
<p>That is all.
Again, we need to assign our new function to class <code>MP</code>:</p>
<pre class="r"><code>class(TCPUE_e)&lt;-&quot;MP&quot;</code></pre>
<p>Let’s test the two MPs and see how they [perform](/welcome-a-quick-tour/examining-results/:</p>
<pre class="r"><code>testMSE&lt;-runMSE(testOM,MPs=c(&quot;TCPUE&quot;,&quot;TCPUE_e&quot;))</code></pre>
<pre><code>## Checking MPs</code></pre>
<pre><code>## Loading operating model</code></pre>
<pre><code>## Optimizing for user-specified movement</code></pre>
<pre><code>## Optimizing for user-specified depletion in last historical year</code></pre>
<pre><code>## Calculating historical stock and fishing dynamics</code></pre>
<pre><code>## Calculating MSY reference points for each year</code></pre>
<pre><code>## Calculating B-low reference points</code></pre>
<pre><code>## Calculating reference yield - best fixed F strategy</code></pre>
<pre><code>## Simulating observed data</code></pre>
<pre><code>## Running forward projections</code></pre>
<pre><code>## 1 / 2 Running MSE for TCPUE</code></pre>
<pre><code>## ..................................................</code></pre>
<pre><code>## 2 / 2 Running MSE for TCPUE_e</code></pre>
<pre><code>## ..................................................</code></pre>
<pre class="r"><code>NOAA_plot(testMSE)</code></pre>
<p><img src="/features-management-procedures/customMPs/_index.en_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<pre><code>##         PNOF B50  LTY    VY
## TCPUE   55.3  62 66.7 100.0
## TCPUE_e 10.0  40 66.7  33.3</code></pre>
</div>
</div>
