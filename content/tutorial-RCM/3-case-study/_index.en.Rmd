---
date: "2021-02-10T11:35:01+06:00"
title: Case study
weight: 3
---

```{r echo = FALSE}
knitr::opts_chunk$set(message = FALSE) 
```

### Pacific cod example
In British Columbia, Canada, Pacific cod was assessed in 2018 with an update in 2020 ([Forrest et al. 2020](https://www.dfo-mpo.gc.ca/csas-sccs/Publications/ResDocs-DocRech/2020/2020_070-eng.html), [DFO 2021](https://www.dfo-mpo.gc.ca/csas-sccs/Publications/ScR-RS/2021/2021_002-eng.html)). Here, data for Area 5ABCD (Hecate Strait and Queen Charlotte Sound) was used to condition operating models, which mimicked the configuration of the delay difference assessments.

### Function call setup
The data and preliminary operating model for Pacific cod 5ABCD is available in SAMtool:

```{r}
library(SAMtool)
data(pcod)
```

The base assessment had the following data and features:

- Single fishing fleet with catch (`pcod$data@Chist`) and mean weight series (`pcod$data@MS`)
- Five indices of abundance (`pcod$data@Index`)
- Maturity and selectivity are knife-edge at age-two
- Priors were set for several indices of abundance to inform stock size in the model
- Priors were also set for stock-recruit steepness and natural mortality
- Initial depletion entering the first year of the model (1956) was estimated as a deviation from equilibrium unfished recruitment

A function call of the conditioning model that incorporates these features looks like this:

```{r}
mat_ogive <- ifelse(0:pcod$OM@maxage < 2, 0, 1)
out <- RCM(OM = pcod$OM, data = pcod$data, 
           condition = "catch", mean_fit = TRUE,
           selectivity = "free", s_selectivity = rep("SSB", ncol(pcod$data@Index)),
           start = list(vul_par = matrix(mat_ogive, length(mat_ogive), 1)),
           map = list(vul_par = matrix(NA, length(mat_ogive), 1),
                      log_early_rec_dev = rep(1, pcod$OM@maxage)),
           prior = pcod$prior)
```

#### Operating model
The preliminary operating model (`pcod$OM`) contains biological parameters for growth, maturity, natural mortality, steepness, recruitment variability that will be used to inform the conditioning model.

The operating models were set up with values of steepness `pcod$OM@cpars$h` and M `pcod$OM@cpars$M` sampled from their respective distributions, the means and standard deviations of which were informed by the posterior of the delay difference assessment.

```{r echo = FALSE}
par(mar = c(5, 4, 1, 1))
hist(pcod$OM@cpars$h, main = "", xlab = "Steepness")
```
```{r echo = FALSE}
par(mar = c(5, 4, 1, 1))
hist(pcod$OM@cpars$M, main = "", xlab = "Natural mortality")
```

#### Selectivity
See the article on setup of fleet and index selectivity [here](https://openmse.com/tutorial-rcm-select/).

Knife-edge selectivity is set up by setting `selectivity = "free"` and providing the selectivity-at-age matrix in the `vul_par` argument. Since selectivity is fixed and not estimated, the `map_vul_par` argument is also provided (a matrix of `NA`).

Index selectivity is informed by the knife-edge maturity in the OM, so argument `s_selectivity` is set to `"SSB"` for all 5 indices.

#### Initial depletion
By default, the RCM generates an unfished population in the first year of the model, but we can estimate a deviation from unfished recruitment as a deviation from equilibrium unfished recruitment. A deviation `log_early_rec_dev` exists for each age cohort (of age-1 and older) in the first year of the model. To set them up as a single estimated parameter, we set the map argument to one for all these parameters `map_log_early_rec_dev = rep(1, OM@maxage)` (the map argument indicates to TMB whether parameter values are shared together or fixed to starting values).

#### Priors on catchability
Priors on index q can be set through `pcod$prior <- list(q = ...)` for two of the five indices, following the assessment:
```{r}
pcod$prior$q
```

#### Results
Model fits and estimated parameters can be found in the markdown reports:
```{r eval = FALSE}
plot(out)
```

Since we sampled steepness and natural mortality from a distribution, a range of historical SSB values is reconstructed:

```{r echo = FALSE}
par(mar = c(5, 4, 1, 1))
matplot(1956:2021, t(out@SSB)/1e2, typ = 'l', col = 1, lty = 1,
        xlab = "Year", ylab = "SSB (mt)", ylim = c(0, 1e3))
abline(h = 0, col = "grey")
```

When conditioned on catch, a range for fishing mortality is similarly produced:
```{r echo = FALSE}
par(mar = c(5, 4, 1, 1))
matplot(1956:2020, t(out@OM@cpars$Find), typ = 'l', col = 1, lty = 1,
        xlab = "Year", ylab = "Fishing mortality",  ylim = c(0, 0.5))
abline(h = 0, col = "grey")
```

For all simulations, the SSB in 2020 is below the upper stock reference (USR), the mean SSB estimated during 1956-2004:

```{r echo = FALSE}
par(mar = c(5, 4, 1, 1))
matplot(1956:2021, t(out@SSB/sapply(out@Misc, function(x) mean(x$E[1956:2021 %in% 1956:2004]))), 
        typ = 'l', col = 1, lty = 1,
        xlab = "Year", ylab = expression(SSB/USR), ylim = c(0, 2.5))
abline(h = 1, lty = 3)
abline(h = 0, col = "grey")
```


These figures are comparable to Figures 19, 20, and 22 of [Forrest et al. 2020](https://www.dfo-mpo.gc.ca/csas-sccs/Publications/ResDocs-DocRech/2020/2020_070-eng.html).

Finally, RCM also generates an updated OM that is ready for closed-loop simulation, where the historical period is conditioned by the estimation model: 

```{r eval = FALSE}
MSE <- MSEtool::runMSE(out@OM, ...)
```

### Alternative operating models

An alternative scenario can be generated where knife-edge maturity and selectivity is age-3 instead of age-2. The following code that updates the maturity and fishery/index selectivity in the OM and RCM:

```{r}
out_age3 <- local({
  pcod$OM@cpars$Mat_age[, 3, ] <- 0
  mat_ogive_age3 <- pcod$OM@cpars$Mat_age[1, , 1]
  RCM(OM = pcod$OM, data = pcod$data, 
      condition = "catch", mean_fit = TRUE,
      selectivity = "free", s_selectivity = rep("SSB", ncol(pcod$data@Index)),
      start = list(vul_par = matrix(mat_ogive_age3, length(mat_ogive_age3), 1)),
      map = list(vul_par = matrix(NA, length(mat_ogive_age3), 1),   
                 log_early_rec_dev = rep(1, pcod$OM@maxage)),
      prior = pcod$prior)
})
```

### Comparing multiple model fits

From multiple OM scenarios and corresponding RCM fits, the `compare_RCM` function allows users to compare RCM fits, estimated parameters, and likelihood values.

```{r eval = FALSE}
compare_RCM(out, out_age3, 
            scenario = list(names = c("Age-2 maturity", "Age-3 maturity")),
            s_name = colnames(pcod$data@Index))
```

The comparison primarily uses the mean scenarios from each OM:

```{r echo = FALSE}
par(mar = c(5, 4, 1, 1))
plot(1956:2021, out@mean_fit$report$E/100, typ = "l", ylim = c(0, 800), xlab = "Year", ylab = "SSB (mt)")
lines(1956:2021, out_age3@mean_fit$report$E/100, col = 2)
abline(h = 0, col = "grey")
legend("topright", c("Age-2 maturity", "Age-3 maturity"), col = 1:2, lty = 1)
```
