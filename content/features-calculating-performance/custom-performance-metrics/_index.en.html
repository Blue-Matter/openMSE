---
date: "2021-02-22T11:35:01+06:00"
title: Custom Performance Metrics
weight: 3
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<p>In this section we describe how to develop custom performance metric functions.</p>
<p>We’ll go through the <code>P50</code> function in detail to see how it works:</p>
<pre class="r"><code>P50</code></pre>
<pre><code>## function (MSEobj = NULL, Ref = 0.5, Yrs = NULL) 
## {
##     Yrs &lt;- ChkYrs(Yrs, MSEobj)
##     PMobj &lt;- new(&quot;PMobj&quot;)
##     PMobj@Name &lt;- &quot;Spawning Biomass relative to SBMSY&quot;
##     if (Ref != 1) {
##         PMobj@Caption &lt;- paste0(&quot;Prob. SB &gt; &quot;, Ref, &quot; SBMSY (Years &quot;, 
##             Yrs[1], &quot; - &quot;, Yrs[2], &quot;)&quot;)
##     }
##     else {
##         PMobj@Caption &lt;- paste0(&quot;Prob. SB &gt; SBMSY (Years &quot;, Yrs[1], 
##             &quot; - &quot;, Yrs[2], &quot;)&quot;)
##     }
##     PMobj@Ref &lt;- Ref
##     PMobj@Stat &lt;- MSEobj@SB_SBMSY[, , Yrs[1]:Yrs[2]]
##     PMobj@Prob &lt;- calcProb(PMobj@Stat &gt; PMobj@Ref, MSEobj)
##     PMobj@Mean &lt;- calcMean(PMobj@Prob)
##     PMobj@MPs &lt;- MSEobj@MPs
##     PMobj
## }
## &lt;bytecode: 0x000000001a531a20&gt;
## &lt;environment: namespace:MSEtool&gt;
## attr(,&quot;class&quot;)
## [1] &quot;PM&quot;</code></pre>
<p>Functions of class <code>PM</code> must have three arguments: <code>MSEobj</code>, <code>Ref</code>, and <code>Yrs</code>:</p>
<pre class="r"><code>args(P50)</code></pre>
<pre><code>## function (MSEobj = NULL, Ref = 0.5, Yrs = NULL) 
## NULL</code></pre>
<ol style="list-style-type: decimal">
<li>The first argument <code>MSEobj</code> is obvious, an object of class <code>MSE</code> to calculate the performance statistic.</li>
<li>The second argument <code>Ref</code> must have a default value. This is used as reference for the performance statistic, and will be demonstrated shortly.</li>
<li>The third argument <code>Yrs</code> can have a default value of <code>NULL</code> or specify a numeric vector of length 2 with the first and last years to calculate the performance statistic, or a numeric vector of length 1 in which case if it is positive it is the first <code>Yrs</code> and if negative the last <code>Yrs</code> of the projection period.</li>
</ol>
<p>The first line of a <code>PM</code> function must be <code>Yrs &lt;- ChkYrs(Yrs, MSEobj)</code>. This line updates the <code>Yrs</code> variable and makes sure that the specified year indices are valid. For example:</p>
<pre class="r"><code>MSEobj &lt;- runMSE(silent=TRUE) # example MSE object

ChkYrs(NULL, MSEobj) # returns all projection years </code></pre>
<pre><code>## [1]  1 50</code></pre>
<pre class="r"><code>ChkYrs(c(1,10), MSEobj) # returns first 10 years </code></pre>
<pre><code>## [1]  1 10</code></pre>
<pre class="r"><code>ChkYrs(c(60,80), MSEobj) # returns message and last 20 years</code></pre>
<pre><code>## Yrs[2] is greater than MSEobj@proyears. Setting Yrs[2] = 
## MSEobj@proyears</code></pre>
<pre><code>## Yrs[1] is greater than MSEobj@proyears. Setting Yrs[1] = Yrs[2] - 
## Yrs[1]</code></pre>
<pre><code>## [1] 30 50</code></pre>
<pre class="r"><code>ChkYrs(5, MSEobj) # first 5 years</code></pre>
<pre><code>## [1] 1 5</code></pre>
<pre class="r"><code>ChkYrs(-5, MSEobj) # last 5 years</code></pre>
<pre><code>## [1] 46 50</code></pre>
<pre class="r"><code>ChkYrs(c(50,10), MSEobj) # returns an error</code></pre>
<pre><code>## Error: Yrs[1] is &gt; Yrs[2]</code></pre>
<p>When the default value for <code>Yrs</code> is <code>NULL</code>, the <code>Yrs</code> variable is updated to include all projection years:</p>
<pre class="r"><code>Yrs &lt;- ChkYrs(NULL, MSEobj)
Yrs</code></pre>
<pre><code>## [1]  1 50</code></pre>
<div id="creating-a-pm-function" class="section level4">
<h4>Creating a PM function</h4>
<p>We’ll go through the steps of creating the <code>P50</code> function.</p>
<p>First, we create a new object of class <code>PMobj</code>, and populate the <code>Name</code> slot with a short but descriptive name:</p>
<pre class="r"><code>PMobj &lt;- new(&quot;PMobj&quot;)
PMobj@Name &lt;- &quot;Spawning Biomass relative to SBMSY&quot;</code></pre>
<p>The next line populates the <code>Caption</code> slot with a brief caption including the years over which the performance statistic is calculated. The <em>if</em> statement is not crucial, but avoids the redundant <code>SB &gt; 1 SBMSY</code> in cases where <code>Ref=1</code>.</p>
<p>Next we store the value of the <code>Ref</code> argument in the <code>PMobj@Ref</code> slot so that information is contained in the function output.</p>
<pre class="r"><code>PMobj@Ref &lt;- Ref</code></pre>
<p>The <code>Stat</code> slot is an array that stores the variable which we wish to calculate the performance statistic; an output from the <code>runMSE</code> function with dimensions <code>MSE@nsim</code>, <code>MSE@nMPs</code>, and <code>MSE@proyears</code> (or fewer if the argument <code>Yrs != NULL</code>).</p>
<p>In this case we want to calculate a performance statistic related to the biomass relative to BMSY, and so we assign the <code>Stat</code> slot as follows:</p>
<pre class="r"><code>PMobj@Stat &lt;- MSEobj@SB_SBMSY[, , Yrs[1]:Yrs[2]]</code></pre>
<p>Note that we are including all simulations and MPs and indexing the years specified in <code>Yrs</code>.</p>
<p>Next we use the <code>calcProb</code> function to calculate the mean of <code>PMobj@Stat &gt; PMobj@Ref</code> over the years dimension. This results in a matrix with dimensions <code>MSE@nsim, MSE@nMPs</code>:</p>
<pre class="r"><code>PMobj@Prob &lt;- calcProb(PMobj@Stat &gt; PMobj@Ref, MSEobj)</code></pre>
<p>Note that in order to calculate a probability the argument to the <code>calcProb</code> function must be a logical array, which is achieved using the <code>Ref</code> slot.</p>
<p>Also note that in this case <code>PMobj@Stat &gt; PMobj@Ref</code> is equivalent to <code>MSEobj@SB_SBMSY[, , Yrs[1]:Yrs[2]] &gt; 0.5</code>.</p>
<p>The <code>PM</code> functions have been designed this way so that in most cases the <code>PMobj@Prob &lt;- calcProb(PMobj@Stat &gt; PMobj@Ref)</code> line is identical in all <code>PM</code> functions and does not need to be modified. The exception to this is if we don’t want to calculate a probability but want the actual mean values of <code>PMobj@Stat</code>, demonstrated in the example below.</p>
<p>In the next line we calculate the mean of <code>PMobj@Prob</code> over simulations using the <code>calcMean</code> function:</p>
<pre class="r"><code>PMobj@Mean &lt;- calcMean(PMobj@Prob)</code></pre>
<p>Similar to the previous line, this line is identical in all <code>PM</code> functions and can be simply copy/pasted from other <code>PM</code> functions without being modified. The <code>Mean</code> slot is a numeric vector of length <code>MSEobj@nMPs</code> with the overall performance statistic, in this case the probability of <span class="math inline">\(\text{SB} &gt; 0.5\text{SB}_\text{MSY}\)</span> across all simulations and years.</p>
<p>Finally, we store the names of the MPs and return the <code>PMobj</code>.</p>
</div>
<div id="creating-example-pms-and-plot" class="section level4">
<h4>Creating Example <code>PMs</code> and Plot</h4>
<p>As an example, we will create another version of <code>DFO_plot</code> using some custom <code>PM</code> functions and a customized version of <code>TradePlot</code>.</p>
<p>First we create the plot using <code>DFO_plot</code>:</p>
<pre class="r"><code>DFO_plot(MSEobj)</code></pre>
<p><img src="/features-calculating-performance/custom-performance-metrics/_index.en_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>From the help documentation (<code>?DFO_plot</code>) we can see that this function plots mean spawning biomass relative to <span class="math inline">\(\text{SB}_\text{MSY}\)</span> and fishing mortality rate relative to <span class="math inline">\(F_\text{MSY}\)</span>
over the final 5 years of the projection.</p>
<p>First we’ll develop a <code>PM</code> function to calculate the mean <span class="math inline">\(\text{SB}_\text{MSY}\)</span> for the last 5 years of the projection period. Notice that this is very similar to <code>P50</code> described above, with the modification of the <code>Caption</code> and the <code>Prob</code> slots, and the <code>Yrs</code> argument. We are calculating a mean here instead of a probability and are not using the <code>Ref</code> argument:</p>
<pre class="r"><code>MeanB &lt;- function(MSEobj = NULL, Ref = 1, Yrs = -5) {
    Yrs &lt;- ChkYrs(Yrs, MSEobj)
    PMobj &lt;- new(&quot;PMobj&quot;)
    PMobj@Name &lt;- &quot;Spawning Biomass relative to SBMSY&quot;
    PMobj@Caption &lt;- paste0(&quot;Mean SB/SBMSY (Years &quot;, Yrs[1], &quot; - &quot;, Yrs[2], &quot;)&quot;)
    PMobj@Ref &lt;- Ref
    PMobj@Stat &lt;- MSEobj@SB_SBMSY[, , Yrs[1]:Yrs[2]]
    PMobj@Prob &lt;- calcProb(PMobj@Stat, MSEobj)
    PMobj@Mean &lt;- calcMean(PMobj@Prob)
    PMobj@MPs &lt;- MSEobj@MPs
    PMobj
}</code></pre>
<p>We develop a <code>PM</code> function to calculate average F/FMSY in a similar way:</p>
<pre class="r"><code>MeanF &lt;- function(MSEobj = NULL, Ref = 1, Yrs = -5) {
    Yrs &lt;- ChkYrs(Yrs, MSEobj)
    PMobj &lt;- new(&quot;PMobj&quot;)
    PMobj@Name &lt;- &quot;Fishing Mortality relative to FMSY&quot;
    PMobj@Caption &lt;- paste0(&quot;Mean F/FMSY (Years &quot;, Yrs[1], &quot; - &quot;, Yrs[2], &quot;)&quot;)
    PMobj@Ref &lt;- Ref
    PMobj@Stat &lt;- MSEobj@F_FMSY[, , Yrs[1]:Yrs[2]]
    PMobj@Prob &lt;- calcProb(PMobj@Stat, MSEobj)
    PMobj@Mean &lt;- calcMean(PMobj@Prob)
    PMobj@MPs &lt;- MSEobj@MPs
    PMobj
}</code></pre>
<p>Similar to <a href="/features-management-procedures/custommps/">developing custom MPs</a> we need to tell R that these new functions are <code>PM</code> methods:</p>
<pre class="r"><code>class(MeanB) &lt;- &quot;PM&quot;
class(MeanF) &lt;- &quot;PM&quot;</code></pre>
<p>Now we can test our performance metric functions:</p>
<pre class="r"><code>data.frame(MP=MeanB(MSEobj)@MPs, 
           SB_SBMSY=MeanB(MSEobj)@Mean, 
           F_FMSY=MeanF(MSEobj)@Mean)</code></pre>
<pre><code>##          MP  SB_SBMSY       F_FMSY
## 1   curEref 0.3258801 2.186392e+00
## 2   FMSYref 0.8950520 1.008874e+00
## 3 FMSYref50 1.9335515 5.044369e-01
## 4 FMSYref75 1.3170624 7.566554e-01
## 5     NFref 4.2925589 4.017549e-15</code></pre>
<p>How do these results compare to what is shown in <code>DFO_plot</code>?</p>
<p>We could also use the <code>summary</code> function with our new <code>PM</code> functions, but note that these results are not probabilities:</p>
<pre class="r"><code>summary(MSEobj, &#39;MeanB&#39;, &#39;MeanF&#39;)</code></pre>
<pre><code>## Calculating Performance Metrics</code></pre>
<pre><code>##                  Performance.Metrics                               
## 1 Spawning Biomass relative to SBMSY  Mean SB/SBMSY (Years 46 - 50)
## 2 Fishing Mortality relative to FMSY    Mean F/FMSY (Years 46 - 50)
## 
## 
## Performance Statistics:
##          MP MeanB   MeanF
## 1   curEref  0.33 2.2e+00
## 2   FMSYref  0.90 1.0e+00
## 3 FMSYref50  1.90 5.0e-01
## 4 FMSYref75  1.30 7.6e-01
## 5     NFref  4.30 4.0e-15</code></pre>
<p>Finally, we will develop a customized plotting function to reproduce the image produced by <code>DFO_plot</code>.</p>
<p>We can produced something fairly similar quite quickly using the <code>TradePlot</code> function:</p>
<pre class="r"><code>TradePlot(MSEobj, &#39;MeanB&#39;, &#39;MeanF&#39;, Lims=c(0,0))</code></pre>
<p><img src="/features-calculating-performance/custom-performance-metrics/_index.en_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<pre><code>##          MP MeanB   MeanF Satisificed
## 1   curEref  0.33 2.2e+00        TRUE
## 2   FMSYref  0.90 1.0e+00        TRUE
## 3 FMSYref50  1.90 5.0e-01        TRUE
## 4 FMSYref75  1.30 7.6e-01        TRUE
## 5     NFref  4.30 4.0e-15        TRUE</code></pre>
<p>Adding the shaded polygons and text requires a little more tweaking and some knowledge of the <code>ggplot2</code> package. We will wrap up our code in a function:</p>
<pre class="r"><code>NewPlot &lt;- function(MSEobj) {
  # create but don&#39;t show the plot
  P &lt;- TradePlot(MSEobj, &#39;MeanB&#39;, &#39;MeanF&#39;, Lims=c(0,0), Show=&#39;none&#39;) 
  P1 &lt;- P$Plots[[1]] # the ggplot objects are returned as a list
  
  # add the shaded regions and the text
  P1 &lt;- P1 + ggplot2::geom_rect(ggplot2::aes(xmin=c(0,0,0), xmax=c(0.4, 0.8, Inf), 
                                       ymin=c(0,0,1), ymax=rep(Inf,3)),
                          alpha=c(0.8, 0.6, 0.4), fill=&quot;grey86&quot;) +
    ggplot2::annotate(geom = &quot;text&quot;, x = c(0.25, 0.6, 1.25), y = Inf, 
                      label = c(&quot;Critical&quot;, &quot;Cautious&quot;, &quot;Healthy&quot;) , 
                      color = c(&#39;white&#39;, &#39;darkgray&#39;, &#39;darkgray&#39;), 
                      size=5, angle = 270, hjust=-0.25)
  
  # Re-order layers so text and points are not covered
  P1$layers &lt;- c(P1$layers, P1$layers[[3]], P1$layers[[4]])
  P1$layers[[3]] &lt;- P1$layers[[4]] &lt;- NULL
  P1
}

NewPlot(MSEobj)</code></pre>
<p><img src="/features-calculating-performance/custom-performance-metrics/_index.en_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
</div>
