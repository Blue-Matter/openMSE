---
date: "2021-03-23T15:18:01+06:00"
title: Conditioning with Catch Data
weight: 1 
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<div id="add-data-to-om" class="section level4">
<h4>Add Data to OM</h4>
<p>To condition our OM with catch data, we create a blank <a href="/object-data">Data object</a>:</p>
<pre class="r"><code>Data &lt;- new(&#39;Data&#39;)</code></pre>
<p>and populate the <code>Year</code>, <code>Cat</code>, and <code>CV_Cat</code> slots with our observed data:</p>
<pre class="r"><code># years - must be length(OM@nyears)
Data@Year &lt;- RealData@Year 

# &#39;real&#39; catches (can be patchy)
Data@Cat &lt;- RealData@Cat[1,,drop=FALSE] 

# assumed CV=0.2 all years
Data@CV_Cat &lt;- matrix(0.2, nrow=1, ncol=length(Data@Year))</code></pre>
<p>and add the <code>Data</code> object to the <code>cpars</code> slot:</p>
<pre class="r"><code>OM &lt;- new(&#39;OM&#39;, Albacore, Generic_IncE, Generic_Obs, Perfect_Imp, nsim=4)
OM@cpars$Data &lt;- Data</code></pre>
</div>
<div id="condition-catch-observation-model" class="section level4">
<h4>Condition Catch Observation Model</h4>
<p>The observation model is conditioned on the catch data when the historical spool-up period is simulated:</p>
<pre class="r"><code>Hist &lt;- Simulate(OM, silent=TRUE)</code></pre>
<p>We can now compare our simulated catch with our ‘real’ observed catches:</p>
<pre class="r"><code># The catch data that are passed to the MPs
ObsCatches &lt;- Hist@Data@Cat

# first 5 years of the &#39;real&#39; catch data
OM@cpars$Data@Cat[1,1:5]</code></pre>
<pre><code>## [1]   82.33424  272.39243 1151.69521 1209.50230  938.61773</code></pre>
<pre class="r"><code># first 5 years of simulated &#39;observed&#39; catch data passed to MPs
ObsCatches[,1:5]</code></pre>
<pre><code>##          [,1]     [,2]     [,3]     [,4]     [,5]
## [1,] 82.33424 272.3924 1151.695 1209.502 938.6177
## [2,] 82.33424 272.3924 1151.695 1209.502 938.6177
## [3,] 82.33424 272.3924 1151.695 1209.502 938.6177
## [4,] 82.33424 272.3924 1151.695 1209.502 938.6177</code></pre>
<pre class="r"><code># first 5 years of catch data simulated from OM
Catches &lt;- apply(Hist@TSdata$Landings, 1:2, sum) # sum over areas
Catches[,1:5]</code></pre>
<pre><code>##          [,1]     [,2]     [,3]     [,4]     [,5]
## [1,] 31.37671 91.56430 153.5310 290.3667 257.0360
## [2,] 48.07154 93.62521 298.8236 306.0257 543.2734
## [3,] 23.25936 50.80173 139.6666 206.6864 240.1686
## [4,] 19.47978 61.13067 103.6633 127.1864 217.8411</code></pre>
<p>The catch observation error <code>Cobs_y</code> in the observation model is updated based on the difference between the ‘real’ catch data and the catch data simulated from the OM. We demonstrate how the catch observation error is calculated here for one simulation:</p>
<pre class="r"><code># simulated catch from 1 simulation
sim &lt;- 2
SimCatch &lt;- Catches[sim,1:OM@nyears] 

# our &#39;real&#39; catch data
ObsCatch &lt;- Data@Cat[1,]

# mean bias
Cbias &lt;- mean(ObsCatch)/mean(SimCatch)

# variability
Cerr &lt;- ObsCatch/(SimCatch*Cbias)

# Catch obs error
Cobs_y &lt;- Cerr * Cbias</code></pre>
<p>You can confirm that the updated catch observation error parameters match <code>Cobs_y</code> for simulation 2:</p>
<pre class="r"><code># check Obs$Cobs_y is the same
cbind(Cobs_y,Hist@SampPars$Obs$Cobs_y[sim,1:OM@nyears])</code></pre>
<p>and by checking that the simulated catch multiplied by the catch observation error is the same as the real catch data provided in the OM:</p>
<pre class="r"><code>plot(Data@Cat[1,], pch=16, xlab=&quot;Year&quot;, ylab=&quot;Catch&quot;)
lines(SimCatch * Hist@SampPars$Obs$Cobs_y[sim,1:OM@nyears])</code></pre>
<p><img src="/features-conditioning-OMs/catch/_index.en_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Presented more generally in equations, catch observation error <span class="math inline">\(E^\text{obs}\)</span> for simulation <em>i</em> in year <em>y</em>:</p>
<p><span class="math display">\[E^\text{obs}_{i,y} = E^\text{err}_{i,y} E^\text{bias}_i\]</span>
where <span class="math inline">\(E^\text{bias}_i\)</span> is bias, calculated as the ratio of mean observed catch <span class="math inline">\(\bar{C^\text{obs}_i}\)</span> to the mean simulated catch <span class="math inline">\(\bar{C^\text{sim}_i}\)</span>:</p>
<p><span class="math display">\[E^\text{bias}_i = \frac{\bar{C^\text{obs}_i}}{\bar{C^\text{sim}_i}}\]</span>
and <span class="math inline">\(E^\text{err}_{i,y}\)</span> is the observation error calculated as:</p>
<p><span class="math display">\[E^\text{err}_{i,y} =  \frac{C^\text{obs}_i}{(C^\text{sim}_i E^\text{bias}_i)}\]</span></p>
<p>Note that observation parameters that are related to <a href="/object-obs/catch_effort/">Catch Sampling</a> (e.g., <code>OM@Cobs</code>) are ignored when the OM is conditioned on catch data.</p>
</div>
<div id="generate-catch-observation-error-for-projection-period" class="section level4">
<h4>Generate Catch Observation Error for Projection Period</h4>
<p>The statistical properties of the catch observation error, conditioned on the observed real catches as demonstrated above, are used to generate the catch observation error for the projection years.</p>
<p>Although all these calculations occur internally, we demonstrate the code here, again for simplicity just showing a single simulation (sim 2).</p>
<p>We calculate the standard deviation in log-space of the standardized catch observation error for the last 10 years of the historical period:</p>
<pre class="r"><code>nyears &lt;- OM@nyears
# standardized catch error to mean 1
Cerr.st &lt;- Cerr[max(nyears-10, 1):nyears]/mean(Cerr[max(nyears-10, 1):nyears])

# standard deviation of log(Cerr.st)
Csd &lt;- sd(log(Cerr.st))</code></pre>
<p>And then generate log-normally distributed catch variability with this standard deviation for the projection years:</p>
<pre class="r"><code># Generate log-normal variability for projection years with same SD
Cerr_proj &lt;- exp(rnorm(OM@proyears, -Csd^2/2, Csd))</code></pre>
<p>Finally, we add the catch bias to the catch variability to produce the catch observation error for the projection period:</p>
<pre class="r"><code># add catch bias
Cobs_proj &lt;- Cerr_proj * Cbias</code></pre>
<p>We can demonstrate that the simulated observed catches in the projection period maintain the same statistical properties as the catch observation error calculated from the historical period.</p>
<p>First, simulate the projection period with an <a href="/features-management-procedures/builtin/#msetool-mps">example reference MP</a>:</p>
<pre class="r"><code>MSE &lt;- Project(Hist, MPs=&quot;FMSYref&quot;, silent=TRUE)</code></pre>
<p>Then we plot the simulated ‘observed’ data (i.e., data passed internally to the MPs) and ‘real’ catches (provided in OM for historical period) (note the last projection year of ‘observed’ data is not available and is replaced with NAs):</p>
<pre class="r"><code>library(ggplot2)
library(tidyr)
library(dplyr)
DF &lt;- data.frame(Sim=1:OM@nsim,
                 Year=rep(1:(OM@nyears+OM@proyears), each=OM@nsim),
                 Simulated=c(as.vector(MSE@CB_hist), as.vector(MSE@Catch[,1,])),
                 Observed=as.vector(cbind(MSE@PPD[[1]]@Cat, rep(NA, OM@nsim)))) %&gt;% 
  tidyr::pivot_longer(cols=3:4) 

ggplot(DF, aes(x=Year, y=value, color=name)) +
  facet_wrap(~Sim, scales=&quot;free&quot;) +
  geom_line(size=1.2) +
  theme_classic() +
  geom_vline(xintercept = OM@nyears, linetype=2) + 
  labs(y=&quot;Catch&quot;, color=&quot;&quot;)</code></pre>
<pre><code>## Warning: Removed 1 row(s) containing missing values (geom_path).</code></pre>
<p><img src="/features-conditioning-OMs/catch/_index.en_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>These plots visually demonstrate that the statistical relationship between the simulated and observed catch data in the historical period (years 1–50) is maintained in the projection period (years 51–100).</p>
</div>
