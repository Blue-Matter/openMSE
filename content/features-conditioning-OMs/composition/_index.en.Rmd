---
date: "2021-03-24T15:18:01+06:00"
title: Conditioning with Composition Data
weight: 4
---
 
```{r, include=FALSE}
library(openMSE)
OM <- new('OM', Albacore, Generic_IncE, Generic_Obs, Perfect_Imp, nsim=4)
RealData <- SimulatedData

printDesc <- function(slot, class="Data") {
  Desc <- get(paste0(class, "Description"))
  Desc$Description[which(Desc$Slot == slot)]
}
```

#### Add Data to OM
To condition our OM with catch-at-age (CAA) and catch-at-length (CAL) data, we create a blank [Data object](/object-data):
```{r}
Data <- new('Data')
```

and populate the `Year`, `CAA`, and `CAL` slots with our observed data:
```{r}
# years - must be length(OM@nyears)
Data@Year <- RealData@Year 

# must be the same as OM@maxage
Data@MaxAge <- RealData@MaxAge

# 'real' CAA (can be patchy)
Data@CAA <- RealData@CAA[1,,,drop=FALSE] 

# an array with dimensions c(1, OM@nyears, OM@maxage+1)
dim(Data@CAA)

# length bins
Data@CAL_bins <- RealData@CAL_bins
Data@CAL_mids <- RealData@CAL_mids

# 'real' CAL (can be patchy)
Data@CAL <- RealData@CAL[1,,,drop=FALSE] 

# an array with dimensions c(1, OM@nyears, length(Data@CAL_mids))
dim(Data@CAL)
```

The selectivity pattern for the CAA and CAL data can be added with the `Data@Vuln_CAA` and `Data@Vuln_CAL` slots:

* `Data@Vuln_CAA`: `r printDesc('Vuln_CAA')`
* `Data@Vuln_CAL`: `r printDesc('Vuln_CAL')`

These selectivity patterns are used to generate the CAA and CAL data in the simulation. 

Note that in the case of real data, `nsim` is always 1 (only one version of the real data!).

We add the `Data` object to the `cpars` slot:
```{r}
OM <- new('OM', Albacore, Generic_IncE, Generic_Obs, Perfect_Imp, nsim=4)
OM@cpars$Data <- Data
```

We also need to add the `CAL_bins` to `cpars`:

```{r}
OM@cpars$CAL_bins <- Data@CAL_bins
```

#### Condition Simulated Data
The observation model is conditioned on the index data when the historical spool-up period is simulated:
```{r}
Hist <- Simulate(OM, silent=TRUE)
```

We can now compare our simulated CAA data with our 'real' observed CAA data:
```{r}
# The CAA data passed to the MPs (first 5 years and 3 age-classes only shown)
Hist@Data@CAA[,1:5,1:3]

# Our 'observed' CAA data (first 5 years and 3 age-classes only shown)
OM@cpars$Data@CAA[,1:5,1:3]

# The CAL data passed to the MPs (first 5 years and 3 length-classes only shown)
Hist@Data@CAL[,1:5,1:3]

# Our 'observed' CAL data (first 5 years and 3 length-classes only shown)
OM@cpars$Data@CAL[,1:5,1:3]

```

Note that the effective sample size in the observation model is NOT updated when CAA and CAL data are provided in the OM. That is, `Obs@CAA_ESS`, and `Obs@CAL_ESS` are not updated. 

`Obs@CAA_nsamp` and `Obs@CAL_nsamp` are updated based on the mean observed sample size for the real data.
