---
date: "2021-03-24T15:18:01+06:00"
title: Conditioning with Composition Data
weight: 4
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<link href="/rmarkdown-libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="/rmarkdown-libs/anchor-sections/anchor-sections.js"></script>


<div id="add-data-to-om" class="section level4">
<h4>Add Data to OM</h4>
<p>To condition our OM with catch-at-age (CAA) and catch-at-length (CAL) data, we create a blank <a href="/object-data">Data object</a>:</p>
<pre class="r"><code>Data &lt;- new(&#39;Data&#39;)</code></pre>
<p>and populate the <code>Year</code>, <code>CAA</code>, and <code>CAL</code> slots with our observed data:</p>
<pre class="r"><code># years - must be length(OM@nyears)
Data@Year &lt;- RealData@Year 

# must be the same as OM@maxage
Data@MaxAge &lt;- RealData@MaxAge

# &#39;real&#39; CAA (can be patchy)
Data@CAA &lt;- RealData@CAA[1,,,drop=FALSE] 

# an array with dimensions c(1, OM@nyears, OM@maxage+1)
dim(Data@CAA)</code></pre>
<pre><code>## [1]  1 50 16</code></pre>
<pre class="r"><code># length bins
Data@CAL_bins &lt;- RealData@CAL_bins
Data@CAL_mids &lt;- RealData@CAL_mids

# &#39;real&#39; CAL (can be patchy)
Data@CAL &lt;- RealData@CAL[1,,,drop=FALSE] 

# an array with dimensions c(1, OM@nyears, length(Data@CAL_mids))
dim(Data@CAL)</code></pre>
<pre><code>## [1]  1 50 28</code></pre>
<p>The selectivity pattern for the CAA and CAL data can be added with the <code>Data@Vuln_CAA</code> and <code>Data@Vuln_CAL</code> slots:</p>
<ul>
<li><code>Data@Vuln_CAA</code>: Optional vulnerability-at-age schedule for catch-at-age samples. Used to condition OM for closed-loop simulation testing. Replaces the fleet selectivity schedule in the OM used to generate CAA samples. Matrix with dimensions nsim x MaxAge+1 .</li>
<li><code>Data@Vuln_CAL</code>: Optional vulnerability-at-length schedule for catch-at-length samples. Used to condition OM for closed-loop simulation testing. Replaces the fleet selectivity schedule in the OM used to generate CAL samples. Matrix with dimensions nsim x length(CAL_mids) .</li>
</ul>
<p>These selectivity patterns are used to generate the CAA and CAL data in the simulation.</p>
<p>Note that in the case of real data, <code>nsim</code> is always 1 (only one version of the real data!).</p>
<p>We add the <code>Data</code> object to the <code>cpars</code> slot:</p>
<pre class="r"><code>OM &lt;- new(&#39;OM&#39;, Albacore, Generic_IncE, Generic_Obs, Perfect_Imp, nsim=4)
OM@cpars$Data &lt;- Data</code></pre>
<p>We also need to add the <code>CAL_bins</code> to <code>cpars</code>:</p>
<pre class="r"><code>OM@cpars$CAL_bins &lt;- Data@CAL_bins</code></pre>
</div>
<div id="condition-simulated-data" class="section level4">
<h4>Condition Simulated Data</h4>
<p>The observation model is conditioned on the index data when the historical spool-up period is simulated:</p>
<pre class="r"><code>Hist &lt;- Simulate(OM, silent=TRUE)</code></pre>
<p>We can now compare our simulated CAA data with our ‘real’ observed CAA data:</p>
<pre class="r"><code># The CAA data passed to the MPs (first 5 years and 3 age-classes only shown)
Hist@Data@CAA[,1:5,1:3]</code></pre>
<pre><code>## , , 1
## 
##      [,1] [,2] [,3] [,4] [,5]
## [1,]   21   28   21   11   11
## [2,]   21   28   21   11   11
## [3,]   21   28   21   11   11
## [4,]   21   28   21   11   11
## 
## , , 2
## 
##      [,1] [,2] [,3] [,4] [,5]
## [1,]   28   28   39   39   28
## [2,]   28   28   39   39   28
## [3,]   28   28   39   39   28
## [4,]   28   28   39   39   28
## 
## , , 3
## 
##      [,1] [,2] [,3] [,4] [,5]
## [1,]   32    7   39   28   53
## [2,]   32    7   39   28   53
## [3,]   32    7   39   28   53
## [4,]   32    7   39   28   53</code></pre>
<pre class="r"><code># Our &#39;observed&#39; CAA data (first 5 years and 3 age-classes only shown)
OM@cpars$Data@CAA[,1:5,1:3]</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]   21   28   32
## [2,]   28   28    7
## [3,]   21   39   39
## [4,]   11   39   28
## [5,]   11   28   53</code></pre>
<pre class="r"><code># The CAL data passed to the MPs (first 5 years and 3 length-classes only shown)
Hist@Data@CAL[,1:5,1:3]</code></pre>
<pre><code>## , , 1
## 
##      [,1] [,2] [,3] [,4] [,5]
## [1,]    0    0    0    0    0
## [2,]    0    0    0    0    0
## [3,]    0    0    0    0    0
## [4,]    0    0    0    0    0
## 
## , , 2
## 
##      [,1] [,2] [,3] [,4] [,5]
## [1,]    0    0    0    0    0
## [2,]    0    0    0    0    0
## [3,]    0    0    0    0    0
## [4,]    0    0    0    0    0
## 
## , , 3
## 
##      [,1] [,2] [,3] [,4] [,5]
## [1,]    0    0    0    0    0
## [2,]    0    0    0    0    0
## [3,]    0    0    0    0    0
## [4,]    0    0    0    0    0</code></pre>
<pre class="r"><code># Our &#39;observed&#39; CAL data (first 5 years and 3 length-classes only shown)
OM@cpars$Data@CAL[,1:5,1:3]</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]    0    0    0
## [2,]    0    0    0
## [3,]    0    0    0
## [4,]    0    0    0
## [5,]    0    0    0</code></pre>
<p>Note that the effective sample size in the observation model is NOT updated when CAA and CAL data are provided in the OM. That is, <code>Obs@CAA_ESS</code>, and <code>Obs@CAL_ESS</code> are not updated.</p>
<p><code>Obs@CAA_nsamp</code> and <code>Obs@CAL_nsamp</code> are updated based on the mean observed sample size for the real data.</p>
</div>
